pipeline {
    agent any

    stages {
        stage('Init') {
            steps {
                sh 'echo ================= RUNNING INIT STEPS =================='
                sh 'mv devops/jenkins/drcicd/*/* .; rm -rf -- */'
                sh 'echo $APPSERVER; ls -lart'
            }
        }
        stage('DRUM Testing') {
            steps {
                sh 'echo ================= RUNNING DRUM STEPS =================='
                // sh 'drum validation -cd . --input surgical-dataset-test.csv --positive-class-label 1 --negative-class-label 0 --target-type binary'
            }
        }
        stage('Upload Custom Model Artifacts') {
            steps {
                sh 'echo ================= RUNNING CM UPLOAD STEPS =================='
                withCredentials([string(credentialsId: 'c88d7131-ddc1-4686-81a7-70e7724c8979', variable: 'drapikey')]) {
                    sh '''
                        curl -X POST $APPSERVER/api/v2/customModels/ \\
                            -H "Authorization: bearer $drapikey" \\
                            -H "Content-Type: application/json" \\
                            -H "Accept: application/json" \\
                            -d \'{"name": "Jenkins Test","targetType": "Binary","targetName": "complication","positiveClassLabel": "1","negativeClassLabel": "0"}\'
                    '''     
                }
                sh '''
                    pwd
                    ls -lrat
                '''
            }
        }
        stage('Perform API Testing'){
            steps {
                sh 'echo ================= RUNNING API TESTING STEPS =================='
                sh 'curl ifconfig.me'
            }
        }
    }

    post {
        always {
            echo "DR CICD PIPELINE DONE"
            deleteDir()
        }
    }
}
